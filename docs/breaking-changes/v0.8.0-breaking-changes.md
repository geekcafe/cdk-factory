# Migration Guide: CDK-Factory v0.8.0

## Breaking Change: Separation of Lambda and API Gateway Stacks

### Overview

CDK-Factory v0.8.0 introduces a **breaking change** that separates Lambda function creation from API Gateway integration. This follows AWS best practices and resolves deployment issues caused by the previous tightly-coupled pattern.

### Why This Change?

**Previous Pattern Issues:**
- ❌ Deployment race conditions when using existing API Gateway stages
- ❌ Only OPTIONS routes deployed (CORS) but not actual Lambda methods
- ❌ Circular dependencies between stacks
- ❌ Violated AWS best practice of separating concerns
- ❌ Difficult to manage Lambda functions independently of API Gateway

**New Pattern Benefits:**
- ✅ Clean separation of concerns (Lambda creation vs API wiring)
- ✅ No deployment conflicts or race conditions
- ✅ Independent Lambda and API Gateway lifecycles
- ✅ Cross-stack communication via SSM Parameter Store
- ✅ Follows AWS recommended patterns
- ✅ Easier testing and debugging

---

## Migration Steps

### Step 1: Update Lambda Stack Configurations

**BEFORE (v0.8.0 - DEPRECATED):**

```json
{
  "name": "{{WORKLOAD_NAME}}-{{ENVIRONMENT}}-health",
  "module": "lambda_stack",
  "enabled": true,
  "api_gateway": {
    "ssm": {
      "enabled": true,
      "workload": "{{WORKLOAD_NAME}}",
      "environment": "{{ENVIRONMENT}}",
      "auto_import": false
    },
    "stage": {
      "name": "prod",
      "use_existing": true
    }
  },
  "resources": [
    {
      "name": "{{WORKLOAD_NAME}}-{{ENVIRONMENT}}-health",
      "src": "./src/handlers/health_score",
      "handler": "app.lambda_handler",
      "description": "Health Score Lambda",
      "api": {
        "route": "/health-score",
        "method": "GET",
        "authorization_type": "NONE",
        "cors": {
          "origins": ["*"],
          "methods": ["GET", "OPTIONS"]
        }
      }
    }
  ]
}
```

**AFTER (v0.8.0 - NEW PATTERN):**

```json
{
  "name": "{{WORKLOAD_NAME}}-{{ENVIRONMENT}}-health",
  "module": "lambda_stack",
  "enabled": true,
  "ssm": {
    "enabled": true,
    "organization": "{{WORKLOAD_NAME}}",
    "environment": "{{ENVIRONMENT}}"
  },
  "resources": [
    {
      "name": "{{WORKLOAD_NAME}}-{{ENVIRONMENT}}-health",
      "src": "./src/handlers/health_score",
      "handler": "app.lambda_handler",
      "description": "Health Score Lambda",
      "environment_variables": {
        "__inherits__": "./configs/common/environment-vars.json"
      },
      "permissions": [
        "dynamodb_read",
        "dynamodb_write"
      ]
    }
  ]
}
```

**Key Changes:**
- ❌ Remove `api_gateway` configuration from stack
- ❌ Remove `api` configuration from each resource
- ✅ Add `ssm.enabled: true` to enable SSM exports
- ✅ Keep all Lambda-specific configuration (src, handler, permissions, env vars)

---

### Step 2: Create API Gateway Stack Configuration

Create a new configuration file for your API Gateway stack:

**`configs/stacks/api-gateway.json`:**

```json
{
  "name": "{{WORKLOAD_NAME}}-{{ENVIRONMENT}}-api-gateway",
  "module": "api_gateway_stack",
  "enabled": true,
  "api_gateway": {
    "name": "{{WORKLOAD_NAME}}-{{ENVIRONMENT}}-api",
    "description": "API Gateway for {{WORKLOAD_NAME}}",
    "api_type": "REST",
    "stage_name": "prod",
    "ssm": {
      "enabled": true,
      "workload": "{{WORKLOAD_NAME}}",
      "environment": "{{ENVIRONMENT}}",
      "exports": {
        "enabled": true
      },
      "imports": {
        "workload": "{{WORKLOAD_NAME}}",
        "environment": "{{ENVIRONMENT}}"
      }
    },
    "deploy_options": {
      "data_trace_enabled": false,
      "metrics_enabled": true,
      "tracing_enabled": true,
      "throttling_rate_limit": 1000,
      "throttling_burst_limit": 2000
    },
    "routes": [
      {
        "path": "/democracy/health-score",
        "method": "GET",
        "lambda_name": "{{WORKLOAD_NAME}}-{{ENVIRONMENT}}-health",
        "authorization_type": "NONE",
        "allow_public_override": true,
        "cors": {
          "origins": ["*"],
          "methods": ["GET", "OPTIONS"],
          "headers": ["Content-Type", "Authorization"]
        }
      }
    ]
  }
}
```

**Key Features:**
- ✅ `lambda_name`: References Lambda by name (auto-discovers ARN from SSM)
- ✅ `ssm.imports`: Configuration for importing Lambda ARNs
- ✅ Routes defined here with API-specific settings (method, path, auth, CORS)

**Alternative: Explicit SSM Path**

If you prefer explicit control:

```json
{
  "path": "/democracy/health-score",
  "method": "GET",
  "lambda_arn_ssm_path": "/my-org/prod/lambda/my-lambda/arn",
  "authorization_type": "NONE"
}
```

---

### Step 3: Update Pipeline Configuration

Update your pipeline to deploy in the correct order:

**`config.json`:**

```json
{
  "workload": {
    "deployments": [
      {
        "pipeline": {
          "stages": [
            {
              "name": "deploy-lambdas",
              "stacks": [
                {
                  "__inherits__": "./configs/stacks/message-lambdas.json"
                },
                {
                  "__inherits__": "./configs/stacks/app-lambdas.json"
                },
                {
                  "__inherits__": "./configs/stacks/health-lambdas.json"
                }
              ]
            },
            {
              "name": "deploy-api-gateway",
              "stacks": [
                {
                  "__inherits__": "./configs/stacks/api-gateway.json"
                }
              ]
            }
          ]
        }
      }
    ]
  }
}
```

**Critical:** API Gateway stack MUST deploy AFTER all Lambda stacks to ensure SSM parameters exist.

---

## SSM Parameter Convention

The new pattern uses SSM Parameter Store for cross-stack communication:

### Lambda Stack Exports

When `ssm.enabled: true`, lambda_stack exports:

```
/{workload}/{environment}/lambda/{lambda-name}/arn
/{workload}/{environment}/lambda/{lambda-name}/function-name
```

**Example:**
```
/workload-name/prod/lambda/workload-name-prod-health/arn
/workload-name/prod/lambda/workload-name-prod-health/function-name
```

### API Gateway Stack Imports

API Gateway stack imports using:
1. **Auto-discovery** (recommended): Specify `lambda_name` in route
2. **Explicit path**: Specify `lambda_arn_ssm_path` in route

---

## Complete Example Migration

### Before: Single Lambda Stack with API

**`health-lambdas.json` (OLD):**
```json
{
  "name": "my-app-prod-health",
  "module": "lambda_stack",
  "api_gateway": {
    "stage": {"name": "prod", "use_existing": true}
  },
  "resources": [
    {
      "name": "my-app-prod-health",
      "src": "./src/handlers/health",
      "handler": "app.lambda_handler",
      "api": {
        "route": "/health",
        "method": "GET",
        "authorization_type": "NONE"
      }
    }
  ]
}
```

### After: Separate Lambda and API Gateway Stacks

**`health-lambdas.json` (NEW):**
```json
{
  "name": "my-app-prod-health-lambdas",
  "module": "lambda_stack",
  "ssm": {
    "enabled": true,
    "workload": "my-app",
    "environment": "prod"
  },
  "resources": [
    {
      "name": "my-app-prod-health",
      "src": "./src/handlers/health",
      "handler": "app.lambda_handler",
      "description": "Health check Lambda"
    }
  ]
}
```

**`api-gateway.json` (NEW):**
```json
{
  "name": "my-app-prod-api-gateway",
  "module": "api_gateway_stack",
  "api_gateway": {
    "name": "my-app-prod-api",
    "api_type": "REST",
    "stage_name": "prod",
    "ssm": {
      "enabled": true,
      "imports": {
        "workload": "my-app",
        "environment": "prod"
      }
    },
    "routes": [
      {
        "path": "/health",
        "method": "GET",
        "lambda_name": "my-app-prod-health",
        "authorization_type": "NONE",
        "allow_public_override": true
      }
    ]
  }
}
```

---

## Troubleshooting

### Error: "DEPRECATED CONFIGURATION DETECTED"

**Cause:** Your lambda_stack config still has `api` or `api_gateway` configuration.

**Solution:** Remove all API Gateway config from lambda_stack and create separate api_gateway_stack.

### Error: "Lambda ARN not found in SSM"

**Cause:** Lambda stack hasn't deployed yet, or SSM export is disabled.

**Solutions:**
1. Ensure Lambda stack deployed successfully
2. Verify `ssm.enabled: true` in lambda_stack config
3. Check SSM Parameter Store for expected paths
4. Ensure API Gateway deploys AFTER Lambda stacks in pipeline

### Error: "Could not resolve Lambda ARN"

**Cause:** `lambda_name` doesn't match actual Lambda name, or wrong SSM path.

**Solutions:**
1. Verify exact Lambda name (check Lambda console or SSM parameters)
2. Ensure workload/environment match in both stacks
3. Use explicit `lambda_arn_ssm_path` if auto-discovery fails

---

## Benefits of New Pattern

### 1. Independent Deployment
- Deploy Lambda updates without touching API Gateway
- Update API Gateway routes without redeploying Lambdas

### 2. Better Testing
- Test Lambda functions in isolation
- Mock API Gateway integration during development

### 3. Cleaner Architecture
- Lambda stacks focus on business logic
- API Gateway stacks focus on routing and security

### 4. Scalability
- Multiple API Gateways can reference same Lambdas
- Easy to add new routes without modifying Lambda stacks

### 5. No CloudFormation Export Limits
- SSM has no 200 export limit
- Cross-account/region support

---

## Need Help?

- **Examples:** `/cdk-factory/samples/separate-api-gateway/`
- **Issues:** https://github.com/geek-cafe/cdk-factory/issues
- **Discussions:** https://github.com/geek-cafe/cdk-factory/discussions

---

## Appendix: Configuration Reference

### Lambda Stack SSM Config

```json
{
  "ssm": {
    "enabled": true,              // Required: Enable SSM exports
    "workload": "my-org",        // Workload name prefix for SSM paths
    "environment": "prod"         // Environment prefix for SSM paths
  }
}
```

### API Gateway Stack SSM Config

```json
{
  "api_gateway": {
    "ssm": {
      "enabled": true,
      "imports": {
        "workload": "my-org",     // Must match Lambda stack
        "environment": "prod"      // Must match Lambda stack
      },
      "exports": {
        "enabled": true             // Optional: Export API Gateway info to SSM
      }
    }
  }
}
```

### Route Configuration Options

```json
{
  "path": "/api/resource",
  "method": "GET|POST|PUT|DELETE|PATCH",
  
  // Option 1: Auto-discovery (recommended)
  "lambda_name": "my-lambda-name",
  
  // Option 2: Explicit SSM path
  "lambda_arn_ssm_path": "/workload/env/lambda/name/arn",
  
  // Authorization
  "authorization_type": "NONE|COGNITO",
  "allow_public_override": true,  // Required for public endpoints with Cognito
  
  // CORS
  "cors": {
    "origins": ["*"],
    "methods": ["GET", "OPTIONS"],
    "headers": ["Content-Type", "Authorization"]
  }
}
```
