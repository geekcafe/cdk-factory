{
  "cdk": {
    "parameters": [
      {
        "placeholder": "{{ENVIRONMENT}}",
        "env_var_name": "ENVIRONMENT",
        "cdk_parameter_name": "Environment"
      },
      {
        "placeholder": "{{WORKLOAD_NAME}}",
        "env_var_name": "CDK_WORKLOAD_NAME",
        "cdk_parameter_name": "WorkloadName"
      },
      {
        "placeholder": "{{CDK_SYNTH_COMMAND_FILE}}",
        "value": "./commands/cdk_synth.sh",
        "cdk_parameter_name": "CdkSynthCommandFile"
      },
      {
        "placeholder": "{{AWS_ACCOUNT}}",
        "env_var_name": "AWS_ACCOUNT_NUMBER",
        "cdk_parameter_name": "AccountNumber"
      },
      {
        "placeholder": "{{DEVOPS_AWS_ACCOUNT}}",
        "env_var_name": "DEVOPS_AWS_ACCOUNT",
        "cdk_parameter_name": "AccountNumber"
      },
      {
        "placeholder": "{{DEVOPS_REGION}}",
        "env_var_name": "DEVOPS_REGION",
        "cdk_parameter_name": "AccountRegion"
      },
      {
        "placeholder": "{{CODE_REPOSITORY_NAME}}",
        "env_var_name": "CODE_REPOSITORY_NAME",
        "cdk_parameter_name": "CodeRepoName"
      },
      {
        "placeholder": "{{CODE_REPOSITORY_ARN}}",
        "env_var_name": "CODE_REPOSITORY_ARN",
        "cdk_parameter_name": "CodeRepoArn"
      },
      {
        "placeholder": "{{GIT_BRANCH}}",
        "env_var_name": "GIT_BRANCH",
        "cdk_parameter_name": "GitBranch"
      }
    ]
  },
  "workload": {
    "name": "full-stack-app",
    "description": "AWS Infrastructure for full-stack-app",
    "devops": {
      "account": "123456789012",
      "region": "us-east-1",
      "code_repository": {
        "name": "github-user-name-or-org/full-stack-app-iac",
        "type": "connector_arn",
        "connector_arn": "arn:aws:codeconnections:us-east-1:123456789012:connection/a90857d9-89b8-4823-ad6f-69a335c20477"
      },
      "commands": [
        {
          "name": "cdk_synth",
          "commands": [],
          "file": "./commands/cdk_synth.sh"
        }
      ]
    },
    "ssm_prefix_template": "/full-stack-app/dev/{resource_type}/{attribute}",
    "stacks": [
      {
        "name": "full-stack-app-dev-vpc",
        "module": "vpc_library_module",
        "enabled": true,
        "vpc": {
          "name": "full-stack-app-dev-vpc",
          "description": "VPC for full-stack-app dev environment",
          "public_subnet_name": "full-stack-app-dev-web-tier",
          "private_subnet_name": "full-stack-app-dev-app-tier",
          "isolated_subnet_name": "full-stack-app-dev-data-tier",
          "cidr": "10.0.0.0/16",
          "max_azs": 2,
          "nat_gateways": {
            "count": 1
          },
          "public_subnets": true,
          "private_subnets": true,
          "isolated_subnets": true,
          "enable_s3_endpoint": true,
          "enable_interface_endpoints": true,
          "interface_endpoints": [
            "ecr.api",
            "ecr.dkr",
            "logs",
            "ssm",
            "secretsmanager"
          ],
          "tags": {
            "Application": "full-stack-app",
            "Environment": "dev"
          },
          "ssm_exports": {
            "vpc_id": "dev/full-stack-app/vpc/id",
            "vpc_cidr": "dev/full-stack-app/vpc/cidr",
            "public_subnet_ids": "dev/full-stack-app/vpc/public-subnet-ids",
            "private_subnet_ids": "dev/full-stack-app/vpc/private-subnet-ids",
            "isolated_subnet_ids": "dev/full-stack-app/vpc/isolated-subnet-ids"
          }
        }
      },
      {
        "name": "full-stack-app-dev-full-stack-sg",
        "module": "security_group_full_stack_library_module",
        "enabled": true,
        "security_group": {
          "name": "full-stack-app-dev-full-stack-sg",
          "description": "Security groups for full-stack-app dev full stack",
          "tags": {
            "Application": "full-stack-app",
            "Environment": "dev"
          },
          "ssm_imports": {
            "vpc_id": "dev/full-stack-app/vpc/id"
          },
          "ssm_exports": {
            "security_group_id": "dev/full-stack-app/sg/<type>/id"
          }
        }
      },
      {
        "name": "full-stack-app-dev-alb",
        "module": "load_balancer_library_module",
        "enabled": true,
        "alb": {
          "name": "full-stack-app-dev-alb",
          "description": "Application Load Balancer for full-stack-app dev environment",
          "scheme": "internet-facing",
          "vpc_id_x": "{{VPC_ID}}",
          "subnet_type": "public",
          "http_to_https_redirect": true,
          "security_group_id": "{{SECURITY_GROUP_ID}}",
          "ssl_policy": "ELBSecurityPolicy-TLS-1-2-2017-01",
          "certificate_arns": [
            "{{ACM_CERTIFICATE_ARN}}"
          ],
          "access_logs": {
            "enabled": true,
            "bucket": "full-stack-app-dev-logs",
            "prefix": "alb-logs"
          },
          "tags": {
            "Application": "full-stack-app",
            "Environment": "dev"
          },
          "ssm_imports": {
            "vpc_id": "dev/full-stack-app/vpc/id",
            "security_group_id": "dev/full-stack-app/sg/alb/id"
          },
          "ssm_exports": {
            "alb_arn": "dev/full-stack-app/alb/arn",
            "alb_dns_name": "dev/full-stack-app/alb/dns-name",
            "alb_zone_id": "dev/full-stack-app/alb/zone-id",
            "https_listener_arn": "dev/full-stack-app/alb/https-listener-arn"
          }
        }
      },
      {
        "name": "full-stack-app-dev-tg",
        "module": "target_group_library_module",
        "enabled": true,
        "target_group": {
          "name": "full-stack-app-dev-tg",
          "description": "Target Group for full-stack-app dev environment",
          "vpc_id": "{{VPC_ID}}",
          "port": 80,
          "protocol": "HTTP",
          "target_type": "instance",
          "health_check": {
            "path": "/health",
            "port": "traffic-port",
            "protocol": "HTTP",
            "healthy_threshold": 3,
            "unhealthy_threshold": 3,
            "timeout": 5,
            "interval": 30
          },
          "stickiness": {
            "enabled": true,
            "duration": 86400,
            "type": "lb_cookie"
          },
          "alb_listener_arn": "{{ALB_HTTPS_LISTENER_ARN}}",
          "listener_rule": {
            "priority": 100,
            "conditions": [
              {
                "field": "path-pattern",
                "values": [
                  "/*"
                ]
              }
            ]
          },
          "tags": {
            "Application": "full-stack-app",
            "Environment": "dev"
          },
          "ssm_imports": {
            "vpc_id": "vpc_id_path",
            "alb_listener_arn": "https_listener_arn_path"
          },
          "ssm_exports": {
            "target_group_arn_path": "arn",
            "target_group_name_path": "name"
          }
        }
      },
      {
        "name": "full-stack-app-dev-lt",
        "module": "launch_template_library_module",
        "enabled": true,
        "launch_template": {
          "name": "full-stack-app-dev-lt",
          "description": "Launch template for full-stack-app dev environment",
          "instance_type": "t3.medium",
          "ami_id": "{{AMI_ID}}",
          "key_name": "{{SSH_KEY_NAME}}",
          "user_data_script": "#!/bin/bash\n\n# Log startup\necho 'Starting application setup' > /var/log/user-data.log\n\n# Update system packages\nyum update -y\n\n# Install Apache web server\nyum install -y httpd\n\n# Create health check endpoint\ncat > /var/www/html/health <<EOF\n<!DOCTYPE html>\n<html>\n<head>\n  <title>Health Check</title>\n</head>\n<body>\n  <h1>OK</h1>\n</body>\n</html>\nEOF\n\n# Create index page\ncat > /var/www/html/index.html <<EOF\n<!DOCTYPE html>\n<html>\n<head>\n  <title>full-stack-app - dev</title>\n</head>\n<body>\n  <h1>Welcome to full-stack-app - dev</h1>\n  <p>Server is up and running!</p>\n</body>\n</html>\nEOF\n\n# Set proper permissions\nchown -R apache:apache /var/www/html\n\n# Start and enable Apache service\nsystemctl start httpd\nsystemctl enable httpd\n\n# Log completion\necho 'Web server setup complete' >> /var/log/user-data.log",
          "iam_instance_profile": "{{INSTANCE_PROFILE_NAME}}",
          "ebs_volumes": [
            {
              "device_name": "/dev/xvda",
              "volume_size": 30,
              "volume_type": "gp3",
              "encrypted": true,
              "delete_on_termination": true
            }
          ],
          "detailed_monitoring": true,
          "tags": {
            "Application": "full-stack-app",
            "Environment": "dev"
          },
          "ssm_imports": {
            "security_group_id": "security_group_id_path"
          },
          "ssm_exports": {
            "launch_template_id_path": "id",
            "launch_template_version_path": "latest-version"
          }
        }
      },
      {
        "name": "full-stack-app-dev-asg",
        "module": "asg_library_module",
        "enabled": true,
        "asg": {
          "name": "full-stack-app-dev-asg",
          "description": "Auto Scaling Group for full-stack-app dev environment",
          "vpc_id": "{{VPC_ID}}",
          "subnet_type": "private",
          "launch_template_id": "{{LAUNCH_TEMPLATE_ID}}",
          "launch_template_version": "{{LAUNCH_TEMPLATE_VERSION}}",
          "min_capacity": 2,
          "max_capacity": 6,
          "desired_capacity": 2,
          "health_check_type": "ELB",
          "health_check_grace_period": 300,
          "target_group_arns": [
            "{{TARGET_GROUP_ARN}}"
          ],
          "scaling_policies": [
            {
              "name": "cpu-scaling",
              "type": "target_tracking",
              "target_value": 70.0,
              "predefined_metric": "ASGAverageCPUUtilization",
              "cooldown": 300
            }
          ],
          "tags": {
            "Application": "full-stack-app",
            "Environment": "dev"
          },
          "ssm_imports": {
            "vpc_id": "vpc_id_path",
            "launch_template_id": "launch_template_id_path",
            "launch_template_version": "launch_template_version_path",
            "target_group_arn": "target_group_arn_path"
          },
          "ssm_exports": {
            "asg_name_path": "name",
            "asg_arn_path": "arn"
          }
        }
      }
    ],
    "deployments": [
      {
        "name": "full-stack-app-dev-pipeline",
        "environment": "dev",
        "account": "123456789012",
        "region": "us-east-1",
        "mode": "pipeline",
        "pipeline": {
          "name": "full-stack-app-dev-pipeline",
          "branch": "main",
          "enabled": true,
          "stages": [
            {
              "name": "Deploy-VPC",
              "stacks": [
                "full-stack-app-dev-vpc"
              ]
            },
            {
              "name": "Deploy-Security-Groups",
              "enabled": false,
              "stacks": [
                "full-stack-app-dev-full-stack-sg"
              ]
            },
            {
              "name": "Deploy-Load-Balancer",
              "enabled": false,
              "stacks": [
                "full-stack-app-dev-alb"
              ]
            },
            {
              "name": "Deploy-Target-Group",
              "enabled": false,
              "stacks": [
                "full-stack-app-dev-tg"
              ]
            },
            {
              "name": "Deploy-Launch-Template",
              "enabled": false,
              "stacks": [
                "full-stack-app-dev-lt"
              ]
            },
            {
              "name": "Deploy-Auto-Scaling-Group",
              "enabled": false,
              "stacks": [
                "full-stack-app-dev-asg"
              ]
            }
          ]
        },
        "enabled": true
      }
    ]
  }
}